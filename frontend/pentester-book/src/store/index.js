import { createStore } from "vuex";
import axios from "axios";

const store = createStore({
  state: {
    commands: [], // Хранит список команд
    isLoaded: false, // Флаг для отслеживания загрузки всех команд
    commandDetails: {}, // Хранит данные для конкретной команды
  },
  mutations: {
    setCommands(state, commands) {
      state.commands = commands;
      state.isLoaded = true; // Устанавливаем флаг, что список команд загружен
    },
    setCommandDetails(state, { id, details }) {
      // Кэшируем данные команды по её ID
      state.commandDetails = {
        ...state.commandDetails,
        [id]: details,
      };
    },
  },
  actions: {
    async fetchCommands({ state, commit }) {
      if (state.isLoaded) return; // Пропускаем запрос, если данные уже загружены

      try {
        const response = await axios.get("/commands/getall");
        const commands = response.data?.data || []; // Извлекаем список команд
        commit("setCommands", commands);
      } catch (error) {
        console.error("Failed to fetch commands:", error);
      }
    },

    async fetchCommandDetails({ state, commit }, id) {
      // Если данные команды уже есть в `state.commandDetails`, пропускаем запрос
      if (state.commandDetails[id]) return state.commandDetails[id];

      try {
        const response = await axios.get(`/commands/${id}/`);
        const details = response.data || {}; // Извлекаем детали команды
        commit("setCommandDetails", { id, details });
        return details;
      } catch (error) {
        console.error(`Failed to fetch details for command ${id}:`, error);
        return null;
      }
    },
  },
  getters: {
    getCommandById: (state) => (id) =>
      state.commands.find((cmd) => cmd.id === id), // Возвращаем команду по ID
    allCommands: (state) => state.commands, // Возвращает весь список команд
    getCommandDetails: (state) => (id) => state.commandDetails[id], // Возвращает детали команды по её ID
  },
});

export default store;
